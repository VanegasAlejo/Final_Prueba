<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Cesium - Barrio La Macarena</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; }
    body { background: #FFEFD4; }
  </style>
</head>
<body>
  <div style="background: #FFEFD4; padding: 38px 0 22px 0; position: relative;">
  <a href="../index.html">
    <img src="logo.png" alt="Logo" style="position: absolute; top: 18px; left: 38px; height: 140px;">
  </a>
    <div style="text-align: center;">
      <div style="font-family: 'Times New Roman', Times, serif; font-size: 3em; font-weight: bold; color: #222; letter-spacing: 1px;">
        Catastro 3D 
      </div>
      <div style="font-family: 'Times New Roman', Times, serif; font-size: 2em; color: #888; font-weight: bold; margin-top: 6px; letter-spacing: 1px;">
        Barrio La Macarena
      </div>
    </div>
  </div>
  <div id="cesiumContainer"></div>

  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MTI1YTkyMi05MjA1LTQzNTgtYWM4OC0xN2JkZGU2NThlM2UiLCJpZCI6MzMxMzYxLCJpYXQiOjE3NTUwNDI1NjV9.ujK4d1Dyo4ltBmS5xJE_pLcFGUwRiAAsfFLzJDkCR3U';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      baseLayer: Cesium.ImageryLayer.fromProviderAsync(
        Cesium.ArcGisMapServerImageryProvider.fromBasemapType(
          Cesium.ArcGisBaseMapType.SATELLITE
        )
      ),
      timeline: false,
      animation: false,
      shadows: true
    });
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 1) Capa del barrio: SOLO para ubicar/recortar (sin extrusión)
    const barrio = await Cesium.GeoJsonDataSource.load("Construccion_Macarena.geojson", {
      clampToGround: true
    });
    viewer.dataSources.add(barrio);
    for (const e of barrio.entities.values) {
      if (!e.polygon) continue;
      e.polygon.material = Cesium.Color.fromCssColorString("#1e88e5").withAlpha(0.25);
      e.polygon.outline = true;
      e.polygon.outlineColor = Cesium.Color.fromCssColorString("#1e88e5"); // Línea azul
      e.polygon.outlineWidth = 4; // Más gruesa y
    }
    await viewer.flyTo(barrio);

    // 2) PREDIOS: extrusión (usa 'altura' o 'pisos'; fallback 6 m)
    // Exporta desde QGIS como EPSG:4326
    const predios = await Cesium.GeoJsonDataSource.load("Construccion_Macarena.geojson", {
      // importante: SIN clampToGround si vas a extruir
    });
    viewer.dataSources.add(predios);

    // Sustituye por este único bucle para extrusión y color:
    let extruidos = 0;
    for (const e of predios.entities.values) {
      const pol = e.polygon;
      if (!pol) continue;

      const props = e.properties || {};
      const hasAltura = props.altura && !isNaN(+props.altura.getValue?.());
      const hasPisos  = props.pisos  && !isNaN(+props.pisos.getValue?.());
      // Multiplica la altura por 1.5 para hacer la extrusión más notoria
      const altura = hasAltura ? +props.altura.getValue() * 2.5
                : hasPisos  ? +props.pisos.getValue() * 3 * 2.5
                            : 6 * 2.5;

      pol.material = Cesium.Color.fromCssColorString("#2ecc40").withAlpha(0.95);
      pol.outline = true;
      pol.outlineColor = Cesium.Color.BLACK;
      pol.height = 1;
      pol.extrudedHeight = altura;
      pol.closeTop = true;
      pol.closeBottom = true;

      extruidos++;
    }
    console.log("Polígonos extruidos:", extruidos);

    // 3) (Opcional) Edificios OSM recortados a la zona del barrio
    // Útil si en OSM hay huellas/alturas; si no, quizá veas pocos.
    const osm = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(osm);

    // Recorta OSM a la envolvente del polígono del barrio
    // (calculamos bbox a partir del primer polígono del barrio)
    const poly = barrio.entities.values.find(e => e.polygon)?.polygon;
    if (poly) {
      const positions = poly.hierarchy.getValue().positions;
      const toDeg = (c) => {
        const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(c);
        return { lon: Cesium.Math.toDegrees(carto.longitude), lat: Cesium.Math.toDegrees(carto.latitude) };
      };
      let west=180, south=90, east=-180, north=-90;
      positions.map(toDeg).forEach(({lon,lat}) => {
        west = Math.min(west, lon);
        east = Math.max(east, lon);
        south= Math.min(south,lat);
        north= Math.max(north,lat);
      });
      const rect = Cesium.Rectangle.fromDegrees(west, south, east, north);
      osm.clippingPlanes = Cesium.ClippingPlaneCollection.fromBoundingRectangle(rect, {
        unionClippingRegions: true,
        edgeWidth: 0.0
      });
    }

    // 4) Cámara inicial manual (debe ir después del flyTo anterior)
    // Calcular el centro del barrio a partir del primer polígono y usar el formato flyTo solicitado
    setTimeout(() => {
      const poly = barrio.entities.values.find(e => e.polygon)?.polygon;
      let lon = -74.0735, lat = 4.6165;
      if (poly) {
        const positions = poly.hierarchy.getValue().positions;
        let sumLon = 0, sumLat = 0;
        positions.forEach(c => {
          const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(c);
          sumLon += Cesium.Math.toDegrees(carto.longitude);
          sumLat += Cesium.Math.toDegrees(carto.latitude);
        });
        lon = sumLon / positions.length;
        lat = sumLat / positions.length;
      }
      // Usar el formato flyTo solicitado
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(lon, lat, 60), // Altura baja: 60 metros
        orientation: {
          heading: Cesium.Math.toRadians(0.0),
          pitch: Cesium.Math.toRadians(-45.0),
        }
      });
    }, 1000);

    // Si quieres animación automática, puedes usar esto:
    /*
    let animando = true;
    let altura = 6;
    function animar() {
      if (!animando) return;
      altura += 0.2;
      if (altura > 50) altura = 6;
      edificios.forEach(pol => pol.extrudedHeight = altura);
      requestAnimationFrame(animar);
    }
    animar();
    */
  </script>
</body>
</html>